---
title: Calculate sample size or power for published microbiome studies with IMPACTT
  guidelines
author: "David Xin Zhao"
date: "Last edited `r format(Sys.time(), '%d %B %Y')`"
knit: (function(inputFile, encoding) {
      out_dir <- 'docs';
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_file=file.path(dirname(inputFile), out_dir, 'index.html'))})
output:
  html_document:
    # theme: cosmo
    highlight: pygments
    df_print: paged
    toc: TRUE
    toc_float: TRUE
    collapsed: FALSE
    number_sections: TRUE
    fig_width: 7
    fig_height: 6
    fig_caption: TRUE
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
---

<html>

<head>

```{=html}
<style>

h1{
 color: #055C9D;
 font-family: Georgia;
 font-size: 200%
}


h2{
 color: #055C9D;
 font-family: helvetica;
 font-size: 150%
}

h3{
 color: #055C9D;  
 font-family: helvetica;
 font-size: 120%; 
}

p {
 color: #333333;
 font-family: helvetica;
 font-size: 100%;
}

.blackbox {
  padding: 1em;
  background: green;
  color: black;
  border: 2px solid orange;
  border-radius: 10px;
}

.center {
  text-align: center;
}

</style>
```
</head>

</html>

```{r setup, include = FALSE}
# set options for the entire document 
knitr::opts_chunk$set(fig.align = 'center', 
                      fig.height=6, fig.width=8,
                      dev="png",
                      echo=TRUE, #display code in output document 
                      error=FALSE,
                      collapse = FALSE, 
                      message=FALSE) #stop render when error occurs   
```

## Problem

Calculating the sample size appropriately is critical in planning a
valid microbiome study. Insufficient sample size will cause poor power
in a hypothesis testing while more-than-enough sample size will cause
resource wasting or even animal/ human ethics problem.

Power is the probability to correctly reject a null hypothesis when it
is false, which indicates how credible a microbiome study is.

Microbiome data has special characteristics different from common data
set, which thus require special methods to calculate sample size or
power.

## Solution

IMPACTT experts provided detailed guidelines in 2021-2022
[@ferdous2022][@beta-div2022], helping microbiome researchers calculate
sample size and power appropriately.

## Project outline

Steps to calculate sample size or power in published microbiome studies:

1.  Identify the research question/ statistical hypothesis
2.  Observe dependent variable distribution and grouping variables
3.  Consider the simple hypothesis test
4.  Determine the standard formulation
5.  Extract parameters from paper
6.  Implement the formulation

Application of the IMPACTT guideline to published work:

1.  Beta-diversity: smoker study[@chen2012]; C-section study[@madan2016]
2.  Alpha-diversity: Canadian infants[@azad2013] and IPA[@chen2021]
3.  Differential abundance analysis of a taxon: vitamin D
    study[@zhao2023]
4.  Microbial cluster membership: food sensitization[@tun2021]
5.  Taxon membership (colonization with a taxon): C. difficile
    colonization[@drall2020]; B. longum subsp. infantis
    colonization[@chen2021]
6.  Longitudinal study: long-term diet and enterotypes[@wu2011]

## R codes

In this project, I applied the effective framework to real dataset,
while practicing R coding skills and familiarizing statistical concepts.

### Worked example: Distance matrix (beta-diversity)

Commonly used measures of microbiota beta-diversity include:

-   Unweighted UniFrac (phylogeny-aware, emphasis on rare taxa)

-   Weighted UniFrac (phylogeny-aware, emphasis on highly abundant taxa)

-   Generalized UniFrac (UniFrac variant, powerful in detecting changes
    of moderately abundant taxa)

-   Jaccard

-   Bray-Curtis

Calculated sample size for the beta-diversity comparison in the
published study in 2016, Effects of Cesarean delivery and formula
supplementation on the intestinal microbiome of six-week old infants.

Formula A is suitable to estimate the required sample size or power, so
that I extracted mean and standard deviations from the original paper.

```{r extract-means-and-std}







```

```{r beta-distance}

# select appropriate beta-diversity measurement 



## distribution assumption: normal distribution 

# method 1: Equation A in Table 2 

# method 2: ANOVA F-test R-square (Equation G in Table 2) 




## distribution assumption: nonparametric distribution 

# scenario 1: distance matrix is known 

# scenario 2: distance matrix is unknown - simulate distance matrix (Kelly et al.)




## distribution assumption: Dirichlet-Multinomial distribution (La Rosa et al.) 

# method: HMP R package  


```

### Case study: Alpha-diversity

Alpha diversity refers to the number of species present in an ecosystem
(richness) as well as the frequency of occurrence of each type of
organisms (evenness).

Commonly used metrics include:

-   Shannon

-   Inverse Simpson

-   Simpson

-   Chao indices

-   Faith's phylogenetic diversity (Faith's PD)

```{r alpha-diversity}


## distribution assumption: normal distribution 

# method 1: Equation A  (explanatory variable is binary) 

# method 2: Equation G for correlation (explanatory variable is continuous)


# convert medians and interquartile ranges to means and standard deviations  

```

### Case study: Differential analysis of taxon abundance

Two types of hypothesis tests:

-   Compare mean abundance of a taxon

-   Compare subject proportion with abundance over a chosen threshold

Type I error threshold, alpha should not need adjustment for multiple
testing, if testing on only single taxon.

Type I error threshold, alpha should be adjusted for multiple testing,
if a study plans to test association at all taxa.

alpha\^star = alpha / M (where M is the planned number of tests)

```{r taxon abundance}

## distribution assumption: ?

# Equation D and E in Table 2 



## distribution assumption: non-normal distribution 

# convert median and IQR to mean and standard deviation (suitable for phylum or higher classification levels) 


```

### Case study: Testing higher or lower rates of cluster membership between groups

```{r cluster membership}

# Equation C an E in table 2 


```

### Case study: Testing higher or lower rates of taxon membership between groups (i.e. colonization with a microbe)

To determine sample sizes for colonization with specific microbiota
(presence/ absence or yes/ no), one can use the equations for
proportions or odds ratios.

```{r taxa colonization}

# Equation C in table 2 



```

### Case study: Longitudinal study (SIMR: An R package for power analysis of generalized linear mixed models by simulation)
